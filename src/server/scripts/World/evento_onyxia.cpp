/*
Preparación del evento:
Dibujos abstractos del mismo para enterarnos de todo:

8======D   ( ) :   <--- Fast - se la come

//teste -- Fast se la come x2


Quests:
A) Texto de quest
B) Objetivos
-->

NPCS:
Lukaer - 1508 Skin:
Barney <El viejo borracho> - Skin 53548
Lady Katrana - Skin 8769 -90016
Onyxia - Skin (LadyKatrana) 8769
Onyxia (II) - Skin (LadyKatrana) 8769
Tydron <El acechadragón> - Skin 23845
Vástago de Onyxia - Skin 397 -- HP ~ 20k  Damage = 200 ~ 500
Subdito del Vuelo Negro- Skin 12891  HP ~ 300k  Damage = 2000 ~ 3700
Machacador del Vuelo Negro - Skin 27225  HP ~ 500k  Damage = 3500 ~ 4000



Misión 1: -30002
Npc quest: Lukaer (Display: ) -90018
Npc inquest: Barney <El viejo borracho> (Display:53548) -90017
Título: La historia de un viejo borracho
Desc: ¿Has escuchado la historia de Barney? Dice que vio un enorme dragón transformándose en una hermosa mujer mientras pescaba en el lago.
Siempre lleva encima unas cuantas cervezas de más, pero la historia es divertida y quizás te gustaría oirla.
Ahora estará en la taberna de la ciudad, búscalo por allí.
Fin: ¿Historia? ¡No es ninguna historia!

Objetivo: Hablar con Barney.



Misión 2: -30003
Npc quest: Barnet <El viejo borracho> -90017
Npc inquest: Barnet <El viejo borracho> -90017
Título: Desenmascarando al dragón
Desc: La vi con mis propios ojos, no fue ninguna ilusión, bien es cierto que llevaba alguna copa de más, pero sé de sobra que fue real. Un dragón negro inmenso descendió de los cielos y se transformó en una hermosa doncella. Al principio pensé que eran imaginaciones mías, pero ayer vi a esa misma mujer caminando por las calles de esta ciudad... ¡Era ella! ¡El dragón está en nuestra ciudad!
¿Quieres comprobarlo? Creo que la llamaban Lady Katrana, búscala y comprueba si es o no es un dragón.
Fin: ¡Sabía que tenía razón! Pero nunca imaginé que sería la mismísima hija de Alamuerte...

Objetivo: Script - Algunos gossip y acaba transformándose en Dragon y sale volando.


Misión 3:
Npc quest: Barnet <El viejo borracho>
Npc inquest: Tydron, El acechadragón
Título: En busca del legendario acechadragones
Desc: Nunca imaginé que se tratara de Onyxia, esto no es algo que alguien como yo pueda tratar, será mejor que busques a Tydron.
Y... creo haberlo visto por las afueras de la ciudad... ¿No estaría buscando a Onyxia? Será mejor que hables con él.
Fin: ¿Onyxia? Sí, en estos momentos estaba siguiéndola.

Objetivo: Hablar con Tydron.

Misión 4: (UNA HORDA - OTRA ALIANZA) < Límite 5 personas - party >
Npc quest: Tydron, El acechadragón
Npc inquest: Tydron, El acechadragón
Título: ¡La descendiente del Vuelo Negro!
Desc: 


Misión 5:


Final Quest:
Npc Quest: Tydron, El acechadragón (Display ID :23845)
Npc inquest: Tydron, El acechadragón
Titulo:  - La caída de la madre linaje.
Desc: Llego la hora $N, es momento de acabar con el linaje de Onyxia, adentrate en su guarida y matala.


Objetivo: Onyxia muerta.
Recompensa ID: 49362



------------------






Comandos quest: 

$B - Salto de línea
$N - Nombre del PJ
$Go:a; - cambios o/a



Viejo Borracho Pescador ID: 53548




Recopilación de la historia de Onyxia:

Hace mucho tiempo, Onyxia dirigía a los ogros Quebrantarrocas a las cavernas en Dragonmurk, sin ningún tipo de malevolencia, simplemente con la intención de encontrar un lugar donde criar a sus numerosos hijos, los cuales abandonarian el lugar para infestar La ciénaga de los Dracos. Ella y sus hijos se volvieron conocidos por aterrorizar a todos los viajeros que se extraviaban en las cercanías de su casa.

Desde la partida de los Ala Muerta, sus ancianos hijos se han levantado a liderar a sus hermanos y recuperar sus numerosas pérdidas. El hijo mas anciano de los Ala Muerta, el maléfico y astuto Nefarian, ha reivindicado la ardiente fortaleza de Cumbre de Roca Negra como su nido. Allí, ayudado por sus fieles dragauros, ha subvertido el recuerdo de los Orcos de Roca Negra y atrapado a los pocos dragones negros que quedaban libres bajo su control.

Uno de los mas poderosos partidiarios de Nefarian es su joven hermana, Onyxia. Un hábil e inteligente dragón que disfruta corrompiendo a las razas mortales entrometiéndose en sus asuntos políticos. Con sus propios fines, es capaz de tomar varias formas humanas y usar su encanto y poder para influenciar en delicadas materias entre las diferentes razas. Onyxia ha asumido el alias una vez usado por su padre: el título del royal House Prestor.

Lady Onyxia wow

Aunque Onyxia tiene un tamaño relativamente pequeño para los dragones negros a su edad, comparte los mismos poderes y habilidades que el resto de su temible raza. Su ardiente respiración puede derretir tanto hierro como acero. Sus ataques físicos, con mordiscos, arañazos o latigazos producidos con su cola, son tan rápidos como un relámpago, casi imparables. Cuando consigues esconderte, Onyxia es capaz de echar a volar con delicadeza y arrasacar con su resbaladiza presa desde arriba.

Aunque Onyxia ha sido vista en los alrededores de la Montaña de Roca Negra, su principal guarida se situa en una ardiente caverna bajo La ciénaga de los Dracos, un sombrío lugar situado en las tierras del Marjal Revolcafango. Allí está protegida por sus familiares, los miembros restantes de los insidiosos Dragones Negros del Vuelo. Allí también se encuentra escondida su nidada de nuevos huevos, esperando a su maduración. No debería de existir alguien que amenazase a Onyxia en su propia guarida – en la lejanía de sus preciados huevos – su ira podría ser terrible, mas allá de nuestra comprensión.

Onyxia ayuda a su hermano, Nefarian, con el control de los humanos, con el fin de volver a llenar el mundo de Dragones Negros del Vuelo. Los heroes del mundo afrontan valientemente los retos, peleando para asegurar la continua supervivencia de sus razas.

Cortesía de Herederos de Thrall
*/

#include "ScriptPCH.h"
#include "ScriptedEscortAI.h"
#include "ObjectMgr.h"
#include "ScriptMgr.h"
#include "World.h"

/*
TEXTOS - Esto va en npc_text

ID -  TEXT

RAMA A:
 - GOSSIP_A
20004 -> Asuntos personales. No es algo que te importe.
 - GOSSIP_B  
  *20005 -> Mi nombre es Lady Katrana, he llegado hace unos dias a esta ciudad.
 - GOSSIP_C
  *20006 ->¿Asuntos que atender? Bueno... supongo que sí, digamos que estoy buscando el lugar adecuado para criar a mis pequeñas... mascotas.
 - GOSSIP_D
20007 -> ¿No crees que estás haciendo demasiadas preguntas?
 - GOSSIP_E
  *20008 -> Pues por ahora no, parece que este no será un buen lugar después de todo.
 - GOSSID_F
  *20009 -> No son de por aquí, por eso este lugar puede no ser muy recomendable para ellos.
 - GOSSID_G
  ----XX----
- GOSSIP_H
   20010-> Supongo que un lugar más cálido y con más reservas alimentarias.
- GOSSIP_I
   20011-> Sí, muchos. Y pronto buscaré más. Adiós.
- GOSSIP_J
  20012-> Es probable... bueno, el tiempo apremia, que tengas un buen dia.
- GOSSIP_K
  20013-> Puede que sí, puede que no. Eso es algo que no te incumbe.
- GOSSIP_L
  20014-> ¿Cómo sabes tú eso? ¿Quién te ha mandado?
- GOSSIP_M
  20015-> ¡Ya es suficiente! No permitiré que algo como tú me hable de esa manera. ¿Un dragón? ¡Desde luego que lo soy! ¡Pero no uno cualquiera!
           ¡Soy la madre linaje, descendiente del señor del vuelo negro Alamuerte!




GOSSIP_A --X                                           GOSSIP_H --------- GOSSIP_L -------- GOSSIP_M ----- GOSSIP_N -> Launch
                                    GOSSIP_E ----------
                GOSSIP_C -----------                   GOSSIP_I -----X
GOSSIP_B -------                    GOSSIP_G --X
                GOSSIP_D --X                           GOSSIP_J -----X
                                    GOSSIP_F ----------
                                                       GOSSIP_K -----X

 

*/


enum text
{

   TEXT_ID_A        = 20004,
   TEXT_ID_B        = 20005,  
   TEXT_ID_C        = 20006,  
   TEXT_ID_D        = 20007,
   TEXT_ID_E        = 20008,
   TEXT_ID_F        = 20009,
   TEXT_ID_H        = 20010,
   TEXT_ID_I        = 20011,
   TEXT_ID_J        = 20012,
   TEXT_ID_K        = 20013,
   TEXT_ID_L        = 20014,
   TEXT_ID_M        = 20015,
   TEXT_ID          = 20016,
};

enum spell{

	SPELL_IMMOLATION_VISUAL = 54690,
	SPELL_PILLAR_OD_FIRE_VISUAL = 43541,

};



/*
Textos de script_texts:
-1000034 - ¡Así es! ¡No tengo tiempo que perder contigo!
-1000035 - Es inútil que intentéis hacer algo, el vuelo negro tarde o temprano dominará estas tierras.


*/

#define GOSSIP_A """\xc2\xbf""Qu""\xC3\xA9"" te trae por aqu""\xC3\xAD""?"
#define GOSSIP_B """\xc2\xbf""Qui""\xC3\xA9""n eres? Nunca antes te hab""\xC3\xAD""a visto."
#define GOSSIP_C """\xc2\xbf""Tienes alg""\xC3\xBA""n asunto que atender por aqu""\xC3\xAD""? Podr""\xC3\xAD""a ayudarte."
#define GOSSIP_D """\xc2\xbf""Te gusta este sitio? ""\xc2\xbf""Est""\xC3\xA1""s buscando algo?"
#define GOSSIP_E "Interesante. ""\xc2\xbf""Y has encontrado el lugar adecuado?"
#define GOSSIP_F "No creo que este sea un buen sitio para criar mascotas, pero... ""\xc2\xbf""de que tipo de 'mascotas' estamos hablando?"
#define GOSSIP_G "Parece dif""\xC3\xAD""cil, espero que encuentres un buen lugar. Adi""\xC3\xB3""s. <Parece que el viejo se equivocaba>"
#define GOSSIP_H """\xc2\xbf""Por qu""\xC3\xA9""? ""\xc2\xbf""Necesitan algo en particular?"
#define GOSSIP_I """\xc2\xbf""Has buscado otros sitios?"
#define GOSSIP_J "S""\xC3\xAD""... puede que el clima no les convenga o algo... ""\xc2\xbf""no?"
#define GOSSIP_K """\xc2\xbf""Entonces te ir""\xC3\xA1""s de aqu""\xC3\xAD""?"
#define GOSSIP_L "Espera un momento... ""\xc2\xbf""De qu""\xC3\xA9"" tipo de mascotas est""\xC3\xA1""s hablando? ""\xc2\xbf""Dragones?"
#define GOSSIP_M "Entonces es eso... tal como me dijeron, t""\xC3\xBA""... tambi""\xC3\xA9""n eres un drag""\xC3\xB3""n."
#define GOSSIP_N """\xc2\xa1""""\xc2\xbf""Onyxia?!"

class Lady_Katrana_Quest2 : public CreatureScript
{
public:
    Lady_Katrana_Quest2() : CreatureScript("Lady_Katrana_Quest2") { }


  bool OnGossipHello(Player* player, Creature* creature)
    {
      if(player->GetQuestStatus(30003) == QUEST_STATUS_INCOMPLETE)
	  {
       player->ADD_GOSSIP_ITEM(GOSSIP_ICON_CHAT, GOSSIP_A, GOSSIP_SENDER_MAIN, GOSSIP_ACTION_INFO_DEF + 1);
	   player->ADD_GOSSIP_ITEM(GOSSIP_ICON_CHAT, GOSSIP_B, GOSSIP_SENDER_MAIN, GOSSIP_ACTION_INFO_DEF + 2);

	  }
  player->SEND_GOSSIP_MENU(TEXT_ID, creature->GetGUID());
  return true;
  }

bool OnGossipSelect(Player* player, Creature* creature, uint32 /*sender*/, uint32 action)
        {
player->PlayerTalkClass->ClearMenus();

  switch(action)
            {
      case GOSSIP_ACTION_INFO_DEF + 1: 
		 player->SEND_GOSSIP_MENU(TEXT_ID_A, creature->GetGUID());
         break;
	  case GOSSIP_ACTION_INFO_DEF + 2: 
		  player->ADD_GOSSIP_ITEM(GOSSIP_ICON_CHAT, GOSSIP_C, GOSSIP_SENDER_MAIN, GOSSIP_ACTION_INFO_DEF + 3);
		  player->ADD_GOSSIP_ITEM(GOSSIP_ICON_CHAT, GOSSIP_D, GOSSIP_SENDER_MAIN, GOSSIP_ACTION_INFO_DEF + 4);
		 player->SEND_GOSSIP_MENU(TEXT_ID_B, creature->GetGUID());
         break;
 	  case GOSSIP_ACTION_INFO_DEF + 3: 
		  player->ADD_GOSSIP_ITEM(GOSSIP_ICON_CHAT, GOSSIP_E, GOSSIP_SENDER_MAIN, GOSSIP_ACTION_INFO_DEF + 5);
		  player->ADD_GOSSIP_ITEM(GOSSIP_ICON_CHAT, GOSSIP_F, GOSSIP_SENDER_MAIN, GOSSIP_ACTION_INFO_DEF + 6);
		  player->ADD_GOSSIP_ITEM(GOSSIP_ICON_CHAT, GOSSIP_G, GOSSIP_SENDER_MAIN, GOSSIP_ACTION_INFO_DEF + 7);
		 player->SEND_GOSSIP_MENU(TEXT_ID_C, creature->GetGUID());
         break;
	  case GOSSIP_ACTION_INFO_DEF + 4: 
		 player->SEND_GOSSIP_MENU(TEXT_ID_D, creature->GetGUID());
         break;
	  case GOSSIP_ACTION_INFO_DEF + 5: 
		  player->ADD_GOSSIP_ITEM(GOSSIP_ICON_CHAT, GOSSIP_H, GOSSIP_SENDER_MAIN, GOSSIP_ACTION_INFO_DEF + 8);
		  player->ADD_GOSSIP_ITEM(GOSSIP_ICON_CHAT, GOSSIP_I, GOSSIP_SENDER_MAIN, GOSSIP_ACTION_INFO_DEF + 9);
		 player->SEND_GOSSIP_MENU(TEXT_ID_E, creature->GetGUID());
         break;
	  case GOSSIP_ACTION_INFO_DEF + 6: 
		  player->ADD_GOSSIP_ITEM(GOSSIP_ICON_CHAT, GOSSIP_J, GOSSIP_SENDER_MAIN, GOSSIP_ACTION_INFO_DEF + 10);
		  player->ADD_GOSSIP_ITEM(GOSSIP_ICON_CHAT, GOSSIP_K, GOSSIP_SENDER_MAIN, GOSSIP_ACTION_INFO_DEF + 11);
		 player->SEND_GOSSIP_MENU(TEXT_ID_F, creature->GetGUID());
         break;
	  case GOSSIP_ACTION_INFO_DEF + 7: 
		 player->CLOSE_GOSSIP_MENU();
         break;
      case GOSSIP_ACTION_INFO_DEF + 8: 
		  player->ADD_GOSSIP_ITEM(GOSSIP_ICON_CHAT, GOSSIP_L, GOSSIP_SENDER_MAIN, GOSSIP_ACTION_INFO_DEF + 12);
		  player->SEND_GOSSIP_MENU(TEXT_ID_H, creature->GetGUID());
         break;
	   case GOSSIP_ACTION_INFO_DEF + 9: 
		  player->SEND_GOSSIP_MENU(TEXT_ID_I, creature->GetGUID());
         break;
	   case GOSSIP_ACTION_INFO_DEF + 10: 
		  player->SEND_GOSSIP_MENU(TEXT_ID_J, creature->GetGUID());
         break;
	   case GOSSIP_ACTION_INFO_DEF + 11: 
		  player->SEND_GOSSIP_MENU(TEXT_ID_K, creature->GetGUID());
         break;
	   case GOSSIP_ACTION_INFO_DEF + 12: 
		  player->ADD_GOSSIP_ITEM(GOSSIP_ICON_CHAT, GOSSIP_M, GOSSIP_SENDER_MAIN, GOSSIP_ACTION_INFO_DEF + 13);
		  player->SEND_GOSSIP_MENU(TEXT_ID_L, creature->GetGUID());
         break;
	   case GOSSIP_ACTION_INFO_DEF + 13: 
		  player->ADD_GOSSIP_ITEM(GOSSIP_ICON_CHAT, GOSSIP_N, GOSSIP_SENDER_MAIN, GOSSIP_ACTION_INFO_DEF + 14);
		  player->SEND_GOSSIP_MENU(TEXT_ID_M, creature->GetGUID());
         break;
	   case GOSSIP_ACTION_INFO_DEF + 14: 
         player->KilledMonsterCredit(90016,0);
		 player->CLOSE_GOSSIP_MENU();
         CAST_AI(Lady_Katrana_Quest2::Lady_Katrana_Quest2AI, creature->AI())->Launcher();
         break;
  }
return true;
}


 CreatureAI* GetAI(Creature* creature) const
    {
        return new Lady_Katrana_Quest2AI (creature);
    }


struct Lady_Katrana_Quest2AI : public ScriptedAI
    {
        Lady_Katrana_Quest2AI(Creature* creature) : ScriptedAI(creature)
        {
            me->SetFlag(UNIT_NPC_FLAGS, UNIT_NPC_FLAG_GOSSIP);
        }

        bool evento;
		bool Orgrimmar;

		bool Ventormenta;
		uint32 Tempor;
		uint32 Phase;

		void Reset()
		  {
			//me->GetMap()->CreatureRelocation(me, 1890.31f, -4671.4101f, 34.9016f, 0.210426f);
			
		 evento = false;
		 Tempor = 5000;
		 Phase = 0;
		 me->SetDisplayId(me->GetCreatureTemplate()->Modelid1);
		  me->RemoveFlag(UNIT_FIELD_FLAGS, UNIT_FLAG_IMMUNE_TO_PC | UNIT_FLAG_IMMUNE_TO_NPC | UNIT_FLAG_NON_ATTACKABLE);
		  me->SetReactState(REACT_PASSIVE);
		   me->SetCanFly(false);
		    me->setFaction(35);
		 
		   Orgrimmar = false;
		   Ventormenta = false;
			    me->SetDisableGravity(false);
                            me->RemoveByteFlag(UNIT_FIELD_BYTES_1, 3, UNIT_BYTE1_FLAG_ALWAYS_STAND | UNIT_BYTE1_FLAG_HOVER);
		}

		void Launcher()
		{
			me->RemoveFlag(UNIT_NPC_FLAGS, UNIT_NPC_FLAG_GOSSIP);
			Phase = 1;
			Tempor = 2000;
			evento = true;	

			if(!Orgrimmar && !Ventormenta)
			{
				if (me->GetZoneId() == 1637) // Orgrimmar
                  Orgrimmar = true;
             	else if (me->GetZoneId() == 1519)
				  Ventormenta = true;


			}
		}

		void UpdateAI(const uint32 diff)
		{	

			if(evento)
			{
		  if (Tempor <= diff)
		  {
           switch (Phase)
		   {
		   case 1:
			   DoScriptText(-1000034, me);
			   Tempor = 500;
			   Phase = 2;
			   break;
		   case 2:
               me->CastSpell(me, SPELL_IMMOLATION_VISUAL,true);
			   me->SetFlag(UNIT_FIELD_FLAGS, UNIT_FLAG_IMMUNE_TO_PC | UNIT_FLAG_IMMUNE_TO_NPC | UNIT_FLAG_NON_ATTACKABLE);
			   me->setFaction(103);
			   Tempor = 4500;
			   Phase = 3;
			   break;
		   case 3:
			   DoScriptText(-1000035, me);
			   Tempor = 2000;
			   Phase = 4;
			   break;
		   case 4:
			   me->CastSpell(me, SPELL_PILLAR_OD_FIRE_VISUAL, true);
			   Tempor = 800;
			   Phase = 5;
			   break;
		   case 5:
			   me->SetDisplayId(8570);
			   Tempor = 4000;
			   Phase = 6;
			   break;
		   case 6:
			    me->SetCanFly(true);
			    me->SetDisableGravity(true);
                me->SetByteFlag(UNIT_FIELD_BYTES_1, 3, UNIT_BYTE1_FLAG_ALWAYS_STAND | UNIT_BYTE1_FLAG_HOVER);
				me->SetSpeed(MOVE_FLIGHT, 2.0f);
			   Tempor = 1000;
			   Phase = 7;
			   break;
	       case 7:
			   if(Orgrimmar)
          me->GetMotionMaster()->MovePoint(0, 1926.96f, -4654.244f, 72.5681f);
			   else if (Ventormenta)
		    me->GetMotionMaster()->MovePoint(0, -8829.03f, 841.646f, 141.92f); //

		  me->DespawnOrUnsummon(45000);
			   Tempor = 300;
			   Phase = 8;
			   break;
		   case 8:

			      if(Orgrimmar)
				  {
			if (me->GetPositionX() == 1926.96f)
			   {
			    me->GetMotionMaster()->MovePoint(0, 1790.283f, -4513.776f, 146.815f);
			   Tempor = 15000;
			   Phase = 9;
			   }else me->GetMotionMaster()->MovePoint(0, 1926.96f, -4654.244f, 72.5681f);
				  }
				  else if (Ventormenta)
				  {
			if (me->GetPositionX() == -8829.03f)
			   {
			    me->GetMotionMaster()->MovePoint(0, -8928.694f, 855.877f, 231.1707f);
			   Tempor = 14000;
			   Phase = 9;
			   }else me->GetMotionMaster()->MovePoint(0, -8829.03f, 841.646f, 141.92f); //
				  }
			   break;
		   case 9:
			   me->DespawnOrUnsummon();
			   Tempor = 300;
			   Phase = 10; 
			   

			   break;
	   	  


		   }
		  }else Tempor -= diff;


			}




		}


};

};





/*

""\xc2\xbf""  -- ¿
""\xc2\xa1""  -- ¡

""\xC3\x81"" => "A", // Á
""\xC3\x89"" => "E", // É
""\xC3\x8D"" => "I", // Í
""\xC3\x93"" => "O", // Ó
""\xC3\x9A"" => "U", // Ú


""\xC3\xA1"" => "a", // á
""\xC3\xA9"" => "e", // é
""\xC3\xAD"" => "i", // í
""\xC3\xB3"" => "o", // ó
""\xC3\xBA"" => "u", // ú
*/

#define GOSSIP_Q4a """\xc2\xa1""Onyxia, no podemos permitir que sigas por aqu""\xC3\xAD""!"



class onyxia_event_q4 : public CreatureScript
{
public:
    onyxia_event_q4() : CreatureScript("onyxia_event_q4") { }

	
  bool OnGossipHello(Player* player, Creature* creature)
    {
      if(player->GetQuestStatus(30005) == QUEST_STATUS_INCOMPLETE || player->GetQuestStatus(30006) == QUEST_STATUS_INCOMPLETE)
	  {
       player->ADD_GOSSIP_ITEM(GOSSIP_ICON_CHAT, GOSSIP_Q4a, GOSSIP_SENDER_MAIN, GOSSIP_ACTION_INFO_DEF + 1);
	  }
  player->SEND_GOSSIP_MENU(TEXT_ID, creature->GetGUID());
  return true;
  }

  bool OnGossipSelect(Player* player, Creature* creature, uint32 /*sender*/, uint32 action)
        {
player->PlayerTalkClass->ClearMenus();

  switch(action)
            {
	   case GOSSIP_ACTION_INFO_DEF + 1: 
		 player->CLOSE_GOSSIP_MENU();
         CAST_AI(onyxia_event_q4::onyxia_event_q4AI, creature->AI())->Launcher();
         break;
  }
return true;
}


 CreatureAI* GetAI(Creature* creature) const
    {
        return new onyxia_event_q4AI (creature);
    }



struct onyxia_event_q4AI : public ScriptedAI
    {
        onyxia_event_q4AI(Creature* creature) : ScriptedAI(creature), Summons(me)
        {}
		 SummonList Summons;

		bool Horda;
		bool Alianza;
		uint32 Phase;
		uint32 Tempor;
		bool FaseAER;
		bool FinalFa;
		uint32 FireBt;
		bool AggroAc;
		uint32 AggroAcu;
		uint32 SummonA;
		uint32 SummonCountA;
		uint32 SummonB;
		uint32 SummonC;
		uint32 SummonCountC;
		bool KillCreditT;
		uint32 FinEvento;
		uint32 Reload;
		
		void Reset()
		{ 
		
		  me->SetFlag(UNIT_NPC_FLAGS, UNIT_NPC_FLAG_GOSSIP);
		  Horda = false;
		  Alianza = false;
		  FinalFa = false;
		  Phase = 1;
		  FaseAER = false;
		  AggroAc = false;
		  KillCreditT = false;
		  SummonCountA = 0;
		  SummonCountC = 0;
		  Tempor = 2000;
		  SummonA = 7000;
		  Reload = 10000;
		  SummonB = 25000;
		  SummonC = 40000;
		  AggroAcu = 5000;
		  FireBt = 15000;
		  me->SetDisplayId(me->GetCreatureTemplate()->Modelid1);
		  me->setFaction(35);
		  			   	me->SetCanFly(false);
			    me->SetDisableGravity(false);
                me->RemoveByteFlag(UNIT_FIELD_BYTES_1, 3, UNIT_BYTE1_FLAG_ALWAYS_STAND | UNIT_BYTE1_FLAG_HOVER);
		 
		Summons.DespawnAll();
		
		}

		void Launcher() // P1
		{
			me->RemoveFlag(UNIT_NPC_FLAGS, UNIT_NPC_FLAG_GOSSIP);
			Phase = 1;
			Tempor = 2000;
			//me->SetFlag(UNIT_FIELD_FLAGS, UNIT_FLAG_IMMUNE_TO_PC | UNIT_FLAG_IMMUNE_TO_NPC | UNIT_FLAG_NON_ATTACKABLE);

			if(!Horda && !Alianza)
			{
				if (me->GetZoneId() == 17) // Horda - Los Baldios
                  Horda = true;
             	else if (me->GetZoneId() == 40) // Alianza
				  Alianza = true;


			}
		}

        void JustSummoned(Creature* summoned)
        {

           /* if (Unit* target = SelectTarget(SELECT_TARGET_RANDOM, 0))
			{
				summoned->AI()->AttackStart(target);
                me->AddThreat(target, 150.0f);
			}*/
			 if (Unit* target =  summoned->FindNearestPlayer(180.0f, true))
                       {
						   if(!target->ToPlayer()->isGameMaster())
						   {
					 summoned->AI()->AttackStart(target);
					 //summoned->GetMotionMaster()->MovePoint(0, target->GetPositionX(), target->GetPositionY(), target->GetPositionZ());
					  summoned->GetMotionMaster()->MoveChase(target);
                     summoned->AddThreat(target, 300.0f);
						   }

			  }

                summoned->setFaction(14);
                Summons.Summon(summoned);
            }

        void SummonedCreatureDespawn(Creature* summon)
        {
            Summons.Despawn(summon);
        }

		    void MoveInLineOfSight(Unit* who)
            {
                if (AggroAc && me->IsWithinDistInMap(who, 120.0f) && who->GetTypeId() == TYPEID_PLAYER)
                {
					
                     me->AddThreat(who, 50.0f);
					// Reload = 20000;

                }

				 if (KillCreditT && me->IsWithinDistInMap(who, 120.0f) && who->GetTypeId() == TYPEID_PLAYER)
                {
                   ((Player*)who)->KilledMonsterCredit(90025,0);
                }
            }


		void UpdateAI(const uint32 diff)
		{	

			if(Horda || Alianza) { if(!FaseAER) {// Si el evento ha comenzado - P1

		  if (Tempor <= diff)
		  {
           switch (Phase)
		   {
		   case 1:
              DoScriptText(-1000036, me);
              me->CastSpell(me, SPELL_IMMOLATION_VISUAL,true);
			  SetCombatMovement(false);
			  me->SetFlag(UNIT_FIELD_FLAGS, UNIT_FLAG_NON_ATTACKABLE);
			  //me->SetReactState(REACT_PASSIVE);
			  me->setFaction(14);
              
			   Tempor = 6500;
			   Phase = 2;
			   break;
		   case 2:
			   me->CastSpell(me, SPELL_PILLAR_OD_FIRE_VISUAL, true);
			   Tempor = 350;
			   Phase = 3;
			   break;
		   case 3:
			    me->SetDisplayId(me->GetCreatureTemplate()->Modelid2);
				
			   Tempor = 2900;
			   Phase = 4;
			   break;
		   case 4:
			  	me->SetCanFly(true);
			    me->SetDisableGravity(true);
                me->SetByteFlag(UNIT_FIELD_BYTES_1, 3, UNIT_BYTE1_FLAG_ALWAYS_STAND | UNIT_BYTE1_FLAG_HOVER); 
			   Tempor = 100;
			   Phase = 5;
			  
			   break;
		   case 5:

			   
				//me->SetSpeed(MOVE_FLIGHT, 1.3f);
				
			   if(Horda)
              me->GetMotionMaster()->MovePoint(0, 431.085f, -1513.804f, 129.187f);
			   else if (Alianza)
              me->GetMotionMaster()->MovePoint(0, -10585.33f, 1653.457f, 78.2451f);

			   Tempor = 3000;
			   Phase = 6;
			   break;
		   case 6:
		 if(Horda)
		  {
				
				   if (me->GetPositionX() == 431.085f)
			   {
				 
               Phase = 1;
               Tempor = 2000;
			   FinEvento = 130000;
			   FaseAER = true;

			   }else me->GetMotionMaster()->MovePoint(0, 431.085f, -1513.804f, 129.187f);

		 }else if (Alianza)
		 {
                  if (me->GetPositionX() == -10585.33f)
			   {
				    
               
			   Phase = 1;
			   Tempor = 2000;
			    FinEvento = 130000;
			   FaseAER = true;
			   }else me->GetMotionMaster()->MovePoint(0, -10585.33f, 1653.457f, 78.2451f);

		}
 break;
		   } }else Tempor -= diff;}
			else{

  if (FinEvento <= diff && !FinalFa)
		  {
          Tempor = 7000;
          Phase = 1; 
          FinalFa = true;

  }else FinEvento -= diff;

  if (!FinalFa) //Spell
  {

			if (Reload <= diff)	{
             if (Unit* target =  me->FindNearestPlayer(230.0f, true))
			 {
				  if(!target->ToPlayer()->isGameMaster())
				  {
						   
                      me->AddThreat(target, 150.0f);

			for(std::list<uint64>::iterator itr = Summons.begin(); itr != Summons.end(); ++itr)
                {
                    if(Creature* temp = Creature::GetCreature(*me,*itr))
					{
						if(!temp->getVictim())
						{
					 temp->AI()->AttackStart(target);
					// temp->GetMotionMaster()->MovePoint(0, target->GetPositionX(), target->GetPositionY(), target->GetPositionZ());
					 temp->GetMotionMaster()->MoveChase(target);
                     temp->AddThreat(target, 300.0f);
					 }

					}		}
				  }

			 }
			 else
			 {
				 Summons.DespawnAll();
				 me->DespawnOrUnsummon();
			 }
			 Reload = 10000;
			}else Reload -= diff;


  if (FireBt <= diff)
		  {
    if (Unit* target = SelectTarget(SELECT_TARGET_RANDOM, 0))
      DoCast(target, 18392);
	  FireBt = urand(10000,15000);
      }else FireBt -= diff;



if (SummonA <= diff) //Invocar Dragoncitos
		  {
   switch (urand(0, 2))
                    {
                        case 0:
							if(Horda)
                            me->SummonCreature(90021, 431.588f, -1491.196f, 92.851f, 0.0f, TEMPSUMMON_CORPSE_DESPAWN);
							else if(Alianza)
							me->SummonCreature(90021, -10570.548f, 1640.8f, 42.063f, 0.0f, TEMPSUMMON_CORPSE_DESPAWN);
							 
                            break;
                        case 1:
							if(Horda)
                          me->SummonCreature(90021, 343.409f, -1489.98f, 92.807f, 0.0f, TEMPSUMMON_CORPSE_DESPAWN);
							else if(Alianza)
						  me->SummonCreature(90021, -10589.37f, 1705.921f, 40.773f, 0.0f, TEMPSUMMON_CORPSE_DESPAWN);
						    
                            break;
					    case 2:
							if(Horda)
                           me->SummonCreature(90021, 388.55f, -1558.72f, 91.8808f, 0.0f, TEMPSUMMON_CORPSE_DESPAWN);
							else if(Alianza)
						   me->SummonCreature(90021, -10636.84f, 1658.134f, 42.097f, 0.0f, TEMPSUMMON_CORPSE_DESPAWN);
						     
                            break;
                    }
    ++SummonCountA;
 SummonA = 600;

 if(SummonCountA >= 15)
 {

SummonA = urand(29000,39000);
SummonCountA = 300;

 }
      }else SummonA -= diff;


  if (SummonB <= diff)
  {
	  switch (urand(0, 2))
                    {
                        case 0:
							if(Horda)
                            me->SummonCreature(90022, 431.588f, -1491.196f, 92.851f, 0.0f, TEMPSUMMON_CORPSE_DESPAWN);
							else if(Alianza)
							me->SummonCreature(90022, -10570.548f, 1640.8f, 42.063f, 0.0f, TEMPSUMMON_CORPSE_DESPAWN);
							  
                            break;
                        case 1:
							if(Horda)
                          me->SummonCreature(90022, 343.409f, -1489.98f, 92.807f, 0.0f, TEMPSUMMON_CORPSE_DESPAWN);
							else if(Alianza)
						 me->SummonCreature(90022, -10589.37f, 1705.921f, 40.773f, 0.0f, TEMPSUMMON_CORPSE_DESPAWN);
						    
                            break;
					    case 2:
							if(Horda)
                           me->SummonCreature(90022, 388.55f, -1558.72f, 91.8808f, 0.0f, TEMPSUMMON_CORPSE_DESPAWN);
							else if(Alianza)
						   me->SummonCreature(90022, -10636.84f, 1658.134f, 42.097f, 0.0f, TEMPSUMMON_CORPSE_DESPAWN);
						    
                            break;
                    }

	  SummonB = urand(25000,45000);
      }else SummonB -= diff;


  if (SummonC <= diff)
  {
	  switch (urand(0, 2))
                    {
                        case 0:
							if(Horda)
                            me->SummonCreature(90021, 431.588f, -1491.196f, 92.851f, 0.0f, TEMPSUMMON_CORPSE_DESPAWN);
							else if(Alianza)
							me->SummonCreature(90021, -10570.548f, 1640.8f, 42.063f, 0.0f, TEMPSUMMON_CORPSE_DESPAWN);
							 
							  
                            break;
                        case 1:
							if(Horda)
                          me->SummonCreature(90021, 343.409f, -1489.98f, 92.807f, 0.0f, TEMPSUMMON_CORPSE_DESPAWN);
							else if(Alianza)
					      me->SummonCreature(90021, -10589.37f, 1705.921f, 40.773f, 0.0f, TEMPSUMMON_CORPSE_DESPAWN);
							
						    
                            break;
					    case 2:
							if(Horda)
                           me->SummonCreature(90021, 388.55f, -1558.72f, 91.8808f, 0.0f, TEMPSUMMON_CORPSE_DESPAWN);
							else if(Alianza)
						   me->SummonCreature(90021, -10636.84f, 1658.134f, 42.097f, 0.0f, TEMPSUMMON_CORPSE_DESPAWN);
						
						    
                            break;
                    }
++SummonCountC;
SummonC = 300;

if(SummonCountC >= 20)
 {
if(Horda)
     me->SummonCreature(90023, 388.55f, -1558.72f, 91.8808f, 0.0f, TEMPSUMMON_CORPSE_DESPAWN);
else if(Alianza)
	 me->SummonCreature(90023, -10636.84f, 1658.134f, 42.097f, 0.0f, TEMPSUMMON_CORPSE_DESPAWN);

SummonC = urand(45000,65000);
SummonCountC = 0;

 }
      }else SummonC -= diff;


  if(!AggroAc)
  {
  if (AggroAcu <= diff)
		  {
			
AggroAcu = 10000;
 AggroAc = true;
  }else AggroAcu -= diff;
  }else{
  if ( AggroAcu <= diff)
		  {
 AggroAcu = 10000;
 AggroAc = false;
  }else AggroAcu -= diff;
  }

  }
if(FinalFa)
{
  if (Tempor <= diff)
		  {
           switch (Phase)
           {
           case 1:
                DoScriptText(-1000037, me);
				Summons.DespawnAll();
				KillCreditT = true;
                
                Tempor = 13000;
		Phase = 2; 
           break;
           case 2:
			   if(Horda)
            me->GetMotionMaster()->MovePoint(0, 398.99f, -1511.205f, 125.5427f);
			   else if (Alianza)
		    me->GetMotionMaster()->MovePoint(0, -10614.703f, 1686.864f, 79.669f);
           Tempor = 6000;
           Phase = 3; 
           break;
           case 3:
           me->DespawnOrUnsummon();
           Tempor = 100;
           Phase = 4; 
           break;
           
           }
}else Tempor -= diff;
}
else
  {
  if (Tempor <= diff)
		  {
           switch (Phase)
		   {
		   case 1:  //WP 1
			    if(Horda)
			  me->GetMotionMaster()->MovePoint(0, 348.002f, -1469.078f, 135.755f);
				else if(Alianza)
			  me->GetMotionMaster()->MovePoint(0, -10583.899f, 1718.911f, 88.414f);
              Tempor = 29000;
			  Phase = 2; 
			   break;
		   case 2:  //WP 2
			    if(Horda)
			  me->GetMotionMaster()->MovePoint(0, 340.964f, -1546.5644f, 165.465f);
				else if(Alianza)
			  me->GetMotionMaster()->MovePoint(0, -10644.086f, 1715.202f, 98.089f);
              Tempor = 29000;
			  Phase = 3; 
		    break;
		    case 3:  //WP 3
				 if(Horda)
			  me->GetMotionMaster()->MovePoint(0, 416.444f, -1570.812f, 165.497f);
				 else if(Alianza)
			  me->GetMotionMaster()->MovePoint(0, -10640.634f, 1655.0996f, 97.1095f);
              Tempor = 29000;
			  Phase = 4; 
			   break;
		    case 4:  //WP 4
				 if(Horda)
			  me->GetMotionMaster()->MovePoint(0, 431.085f, -1513.804f, 133.187f);
				 else if(Alianza)
			  me->GetMotionMaster()->MovePoint(0, -10585.33f, 1653.457f, 78.2451f);
              Tempor = 25000;
			  Phase = 1; 
			   break;

		   }
  }else Tempor -= diff;
  }





			}
	
			
			}

		
		
		
		}
    }; 
  };


class trigger_pre_spawn : public CreatureScript
{
public:
    trigger_pre_spawn() : CreatureScript("trigger_pre_spawn") { }


 CreatureAI* GetAI(Creature* creature) const
    {
        return new trigger_pre_spawnAI (creature);
    }


struct trigger_pre_spawnAI : public ScriptedAI
    {
        trigger_pre_spawnAI(Creature* creature) : ScriptedAI(creature)
        {}

        uint32 MdCount;

		void Reset()

		  {
			  MdCount = 5000;
		}

	void UpdateAI(const uint32 diff)
		{	

if (me->GetEntry() == 90019) //Quest 2 -> Spawn Onyxia
    {
       if (MdCount <= diff)
          {
         if (Creature* Ony = me->FindNearestCreature(90016, 50.0f))
          MdCount = 5000;
         else{
       me->SummonCreature(90016, me->GetPositionX(), me->GetPositionY(), me->GetPositionZ(), me->GetOrientation(),TEMPSUMMON_MANUAL_DESPAWN);
       MdCount = 8000; }
  }else MdCount -= diff;

}
if (me->GetEntry() == 90024) //Quest 4 -> Spawn Onyxia
   {
       if (MdCount <= diff)
          {
         if (Creature* Ony = me->FindNearestCreature(90025, 210.0f))
          MdCount = 15000;
         else{
       me->SummonCreature(90025, me->GetPositionX(), me->GetPositionY(), me->GetPositionZ(), me->GetOrientation(),TEMPSUMMON_MANUAL_DESPAWN);
       MdCount = 35000; }
  }else MdCount -= diff;

}
	}

};
};


void AddSC_evento_onyxia()
{
	 new Lady_Katrana_Quest2();
	 new trigger_pre_spawn();
	 new onyxia_event_q4();
}











